// Prisma Schema - Landing Builder + Admin Panel
// Phase 1: Multisite, Page Hierarchy, Tags, Media Folders, Reusable Blocks, Menus
// Для переключения на PostgreSQL измените provider и DATABASE_URL

datasource db {
  provider = "sqlite"
  // provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

// ==========================================
// SITE (Multisite Support)
// ==========================================

model Site {
  id          Int      @id @default(autoincrement())
  name        String                    // "Мой сайт"
  slug        String   @unique          // "my-site" (для URLs)
  domain      String?  @unique          // "example.com"
  subdomain   String?  @unique          // "site1" (site1.platform.com)

  // Owner
  ownerId     Int
  owner       User     @relation("SiteOwner", fields: [ownerId], references: [id])

  // Settings (JSON)
  settings    String   @default("{}")   // Настройки сайта

  // Relations
  pages           Page[]
  media           Media[]
  mediaFolders    MediaFolder[]
  siteSettings    SiteSetting[]
  themeOverrides  ThemeOverride[]
  menus           Menu[]
  reusableBlocks  ReusableBlock[]
  tags            Tag[]
  userSites       UserSite[]      // Phase 3: users with access

  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("sites")
}

// ==========================================
// USER & AUTH
// ==========================================

model User {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  password     String   // bcrypt hash
  name         String?
  role         String   @default("editor") // admin, editor, viewer
  isSuperadmin Boolean  @default(false)    // Phase 3: superadmin flag
  isActive     Boolean  @default(true)     // Phase 3: can disable users

  // Relations
  pages           Page[]
  media           Media[]
  sessions        Session[]
  ownedSites      Site[]          @relation("SiteOwner")
  reusableBlocks  ReusableBlock[]
  userSites       UserSite[]      // Phase 3: site access permissions

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

// ==========================================
// USER-SITE ACCESS (Phase 3)
// ==========================================

model UserSite {
  id          Int      @id @default(autoincrement())
  userId      Int
  siteId      Int
  permissions String   @default("{}") // JSON: {"pages": true, "blocks": true, ...}
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  site        Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@unique([userId, siteId], name: "userId_siteId")
  @@index([userId])
  @@index([siteId])
  @@map("user_sites")
}

model Session {
  id           Int      @id @default(autoincrement())
  userId       Int
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  refreshToken String   @unique
  userAgent    String?
  ipAddress    String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([refreshToken])
  @@map("sessions")
}

// ==========================================
// PAGES (Landing Builder)
// ==========================================

model Page {
  id          Int      @id @default(autoincrement())
  slug        String
  title       String
  description String?

  // Sections as JSON string
  sections    String   @default("[]") // JSON array of section objects

  // Layout configuration
  headerConfig String? // JSON object
  footerConfig String? // JSON object
  hideHeader   Boolean @default(false)
  hideFooter   Boolean @default(false)

  // SEO
  metaTitle       String?
  metaDescription String?
  ogImage         String?
  canonicalUrl    String?
  noindex         Boolean @default(false)

  // Publishing
  status      String   @default("draft") // draft, published
  publishedAt DateTime?

  // Build options
  prerender   Boolean  @default(true) // SSG by default

  // === NEW: Multisite ===
  siteId      Int
  site        Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)

  // === NEW: Page Hierarchy (до 3 уровней) ===
  parentId    Int?
  parent      Page?    @relation("PageHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children    Page[]   @relation("PageHierarchy")
  order       Int      @default(0)  // Порядок сортировки
  level       Int      @default(0)  // 0, 1, 2 (до 3 уровней)
  path        String?               // "/parent/child/grandchild" для быстрого поиска

  // Relations
  authorId    Int
  author      User     @relation(fields: [authorId], references: [id])

  // === NEW: Tags ===
  tags        PageTag[]

  // === NEW: Reusable Blocks ===
  blockUsages BlockUsage[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([siteId, slug])  // Slug уникален в рамках сайта
  @@index([siteId])
  @@index([status])
  @@index([authorId])
  @@index([parentId])
  @@index([path])
  @@map("pages")
}

// ==========================================
// TAGS (for Pages)
// ==========================================

model Tag {
  id        Int       @id @default(autoincrement())
  name      String
  slug      String
  color     String?   // Цвет для UI (hex)

  // Multisite
  siteId    Int
  site      Site      @relation(fields: [siteId], references: [id], onDelete: Cascade)

  // Relations
  pages     PageTag[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([siteId, slug])
  @@index([siteId])
  @@map("tags")
}

model PageTag {
  pageId    Int
  tagId     Int
  page      Page      @relation(fields: [pageId], references: [id], onDelete: Cascade)
  tag       Tag       @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([pageId, tagId])
  @@map("page_tags")
}

// ==========================================
// MEDIA
// ==========================================

model MediaFolder {
  id        Int      @id @default(autoincrement())
  name      String
  slug      String

  // Hierarchy
  parentId  Int?
  parent    MediaFolder?  @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children  MediaFolder[] @relation("FolderHierarchy")

  // Multisite
  siteId    Int
  site      Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)

  // Relations
  media     Media[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([siteId, parentId, slug])
  @@index([siteId])
  @@index([parentId])
  @@map("media_folders")
}

model Media {
  id        Int      @id @default(autoincrement())
  filename  String   // stored filename
  originalName String // original upload name
  path      String   // relative path: /images/file.jpg
  url       String   // full URL: /api/media/images/file.jpg
  type      String   // image, video, document
  mimeType  String
  size      Int      // bytes

  // Metadata
  alt       String?
  caption   String?
  width     Int?     // for images
  height    Int?     // for images
  duration  Int?     // for videos (seconds)

  // === NEW: Multisite ===
  siteId    Int?
  site      Site?    @relation(fields: [siteId], references: [id], onDelete: SetNull)

  // === NEW: Folder ===
  folderId  Int?
  folder    MediaFolder? @relation(fields: [folderId], references: [id], onDelete: SetNull)

  // Relations
  uploadedById Int?
  uploadedBy   User?    @relation(fields: [uploadedById], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([type])
  @@index([uploadedById])
  @@index([siteId])
  @@index([folderId])
  @@map("media")
}

// ==========================================
// REUSABLE BLOCKS
// ==========================================

model ReusableBlock {
  id          Int      @id @default(autoincrement())
  name        String                    // "Hero + Features комбо"
  slug        String
  description String?
  sections    String   @default("[]")   // JSON массив секций
  category    String?                   // Категория блока
  thumbnail   String?                   // Превью изображение

  // Multisite
  siteId      Int
  site        Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)

  // Author
  authorId    Int
  author      User     @relation(fields: [authorId], references: [id])

  // Usage tracking
  usages      BlockUsage[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([siteId, slug])
  @@index([siteId])
  @@index([authorId])
  @@map("reusable_blocks")
}

model BlockUsage {
  id          Int      @id @default(autoincrement())

  blockId     Int
  block       ReusableBlock @relation(fields: [blockId], references: [id], onDelete: Cascade)

  pageId      Int
  page        Page     @relation(fields: [pageId], references: [id], onDelete: Cascade)

  position    Int      // Позиция в странице (индекс секции после которой вставлен)

  createdAt   DateTime @default(now())

  @@unique([pageId, position])
  @@index([blockId])
  @@index([pageId])
  @@map("block_usages")
}

// ==========================================
// MENUS
// ==========================================

model Menu {
  id        Int      @id @default(autoincrement())
  name      String                    // "Главное меню", "Footer меню"
  slug      String                    // "main", "footer"
  location  String   @default("header") // header, footer, sidebar
  items     String   @default("[]")   // JSON массив MenuItem

  // Multisite
  siteId    Int
  site      Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([siteId, slug])
  @@index([siteId])
  @@map("menus")
}

// ==========================================
// SITE SETTINGS
// ==========================================

model SiteSetting {
  id    Int    @id @default(autoincrement())
  key   String
  value String // JSON value

  // Grouping for UI
  group String @default("general") // general, theme, header, footer, seo

  // === NEW: Multisite ===
  siteId    Int
  site      Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)

  updatedAt DateTime @updatedAt

  @@unique([siteId, key])  // Key уникален в рамках сайта
  @@index([siteId])
  @@index([group])
  @@map("site_settings")
}

// ==========================================
// THEME CUSTOMIZATION
// ==========================================

model ThemeOverride {
  id        Int      @id @default(autoincrement())
  name      String   // e.g., "colors.light.primary"
  value     String   // CSS value
  isActive  Boolean  @default(true)

  // === NEW: Multisite ===
  siteId    Int
  site      Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([siteId, name])  // Name уникален в рамках сайта
  @@index([siteId])
  @@map("theme_overrides")
}
