# Feedback v6 - Products List Currency Error

**Date:** 2025-12-29
**Tester:** Claude Code CLI (Integrator)
**Branch:** `main`
**Status:** V5 bugs fixed, new frontend bug found

---

## V5 Testing Summary

| Bug | Status | Notes |
|-----|--------|-------|
| Bug #1 - Categories UI | FIXED | Категория "Электроника" отображается |
| Bug #2 - Short description | NOT TESTED | Не смог открыть товар из-за Bug #7 |
| Bug #3 - Export 500 | FIXED | Hot-fix: route order (CLI) |
| Bug #4 - Orders 404 | FIXED | "Заказов пока нет" отображается |
| Bug #5 - Promo 404 | FIXED | Таблица промокодов загружается |
| Bug #6 - Payments 404 | FIXED | Страница платежей загружается |

---

## Bug #7: Products List - Invalid Currency Code (Score: 8)

**URL:** https://saas.mix-id.ru/admin/products

**Symptom:**
- Страница показывает "Загрузка..." бесконечно
- В консоли ошибка: `RangeError: Invalid currency code : 0`

**Console error:**
```
RangeError: Invalid currency code : 0
    at new NumberFormat (<anonymous>)
    at Ft (ProductsList.BP28qfRg.js:1:7244)
```

**Root cause analysis:**
- API возвращает 200 OK с корректными данными
- Товары в БД имеют правильный формат цен: `{"KZT":599990}`, `{"RUB":1000,"USD":10}`
- Валюты в БД: KZT, RUB, USD (все присутствуют)
- Ошибка в frontend компоненте `ProductsList.svelte` при форматировании цены
- `Intl.NumberFormat` получает `0` вместо кода валюты (например "KZT")

**Likely bug location:**
Frontend компонент пытается использовать числовой индекс (0) вместо кода валюты при итерации по ценам.

**Files to check:**
- `frontend-astro/src/components/admin/ProductsList.svelte` - функция форматирования цены
- Поиск: `NumberFormat`, `formatPrice`, `formatCurrency`

**Fix approach:**
```typescript
// Вероятная проблема (псевдокод):
Object.entries(prices).forEach((price, index) => {
  // index = 0, 1, 2... используется вместо currency code
  new Intl.NumberFormat('ru-RU', { style: 'currency', currency: index }) // BUG!
})

// Правильно:
Object.entries(prices).forEach(([currencyCode, amount]) => {
  new Intl.NumberFormat('ru-RU', { style: 'currency', currency: currencyCode })
})
```

---

## Hot-fixes Applied by CLI

### Fix: Export Route Order
**Commit:** `4d64657`
**File:** `backend-hono/src/index.ts`
**Change:** Moved `productImportExport` router BEFORE `products` router

```typescript
// Before (Bug):
app.route('/api/admin/products', products);        // /:id catches /export
app.route('/api/admin/products', productImportExport);

// After (Fixed):
app.route('/api/admin/products', productImportExport); // /export matched first
app.route('/api/admin/products', products);
```

### Fix: Missing Currencies
**Action:** Added RUB and USD currencies to database (were missing, causing some price display issues)

---

## What Works Now

- Categories: list, create, edit
- Orders: empty state, filters
- Promo codes: empty state, create button
- Payments: providers list
- Export: JSON download works
- Import: file upload works
- Stats: dashboard displays
- Reviews: moderation works
- Notifications: low stock alerts

---

## Priority

**Critical:**
1. **Bug #7** - Products list broken (admin cannot manage products)

**Medium:**
2. **Bug #2** - Short description (verify after Bug #7 fixed)

---

## Branch to create

`claude/fix-products-currency-format-v6`

---

*Generated by CLI Integrator - V5 Verification + V6 Report (Workflow v4.2)*
