# Feedback v3 - Runtime API Errors (Public Endpoints)

**Date:** 2025-12-24
**Branch:** `claude/fix-ecommerce-build-errors-zfm1d`
**Status:** DEPLOYED - Build successful, runtime errors remain

---

## Summary

TypeScript build errors are fixed. Database schema applied (35 tables created). However, there are **runtime API errors** preventing the E-commerce catalog from working.

---

## What Works

- ✅ Main page loads
- ✅ Admin login page loads
- ✅ Blog pages work
- ✅ `/api/currencies/public` → 200 OK
- ✅ Backend starts without crash
- ✅ All 35 database tables exist

---

## Bug 1: Public endpoints return 401 Unauthorized

**Score:** 8 (Complexity: 2×3=6, Files: 2×2=4, Risk: -2)

**Endpoints affected:**
```
GET /api/categories/public → 401
GET /api/products/public → 401
GET /api/products/public/featured → 401
```

**Expected:** These are PUBLIC endpoints, should return data without authentication.

**Actual:** Returns 401 Unauthorized.

**Files to check:**
- `backend-hono/src/routes/categories.ts` - public route registration
- `backend-hono/src/routes/products.ts` - public route registration
- `backend-hono/src/index.ts` - route mounting order and middleware

**Likely cause:**
The routes may be mounted under a path that has auth middleware applied, or the public routes aren't properly separated from authenticated routes.

**Fix approach:**
1. Check how `/api/currencies/public` works (it returns 200)
2. Apply same pattern to categories and products public routes
3. Ensure public routes are mounted BEFORE auth middleware is applied

---

## Bug 2: Cart API returns 500 - siteId undefined

**Score:** 7 (Complexity: 2×3=6, Files: 2×2=4, Risk: -3)

**Endpoint:** `GET /api/cart`

**Error log:**
```
prisma:error
Invalid `prisma.cart.create()` invocation:
{
  data: {
    sessionId: "b9888a4d-a7ac-47af-82c0-f253d598c679",
    siteId: undefined,
    ...
  }
}
```

**Root cause:** The cart creation requires `siteId` but no site exists in the database yet, and the middleware returns `undefined`.

**Files to check:**
- `backend-hono/src/routes/cart.ts` - getOrCreateCart function
- `backend-hono/src/middleware/site.ts` - publicSiteMiddleware

**Fix options:**

Option A: Create default site on startup
```typescript
// In db initialization or startup script
async function ensureDefaultSite() {
  const site = await prisma.site.findFirst();
  if (!site) {
    await prisma.site.create({
      data: {
        name: 'Default Site',
        slug: 'default',
        domain: 'saas.mix-id.ru',
        isActive: true
      }
    });
  }
}
```

Option B: Make siteId optional with fallback
```typescript
// In cart.ts
const siteId = c.get('siteId') || 1; // fallback to default
```

Option C: Handle missing site gracefully
```typescript
if (!siteId) {
  return c.json({ items: [], total: 0 }, 200);
}
```

**Recommended:** Option A - create default site, as multisite feature expects at least one site.

---

## Database Status

All tables exist (verified via sqlite3):
```
block_usages, cart_items, carts, currencies, integrations_1c,
media, media_folders, menus, notification_settings, order_items,
order_status_history, orders, page_tags, pages, payment_providers,
product_attributes, product_categories, product_images, product_modifiers,
product_variants, products, promo_codes, reusable_blocks, reviews,
sessions, shipping_methods, site_settings, sites, tags, theme_overrides,
user_sites, users, wishlist_items, wishlists
```

**Note:** `sites` table is empty - need to create default site.

---

## How to Test

```bash
# Test public endpoints
curl https://saas.mix-id.ru/api/currencies/public  # Should return 200
curl https://saas.mix-id.ru/api/categories/public  # Currently 401, should be 200
curl https://saas.mix-id.ru/api/products/public    # Currently 401, should be 200

# Test cart (after site fix)
curl https://saas.mix-id.ru/api/cart              # Currently 500, should be 200
```

---

## Recommended Fix Order

1. First: Fix public endpoints auth issue (Bug 1)
   - This unblocks the catalog page

2. Second: Add default site creation (Bug 2)
   - This enables cart functionality

3. Verify: Run `npx tsc --noEmit` before pushing

---

## Branch to update

Update existing branch: `claude/fix-ecommerce-build-errors-zfm1d`

Or create new: `claude/fix-public-endpoints-v3`

---

*Generated by CLI Integrator (Workflow v4.2)*
