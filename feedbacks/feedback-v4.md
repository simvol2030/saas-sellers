# Feedback v4 - Frontend JavaScript Errors

**Date:** 2025-12-24
**Branch:** `main` (after merging all v1-v3 fixes)
**Status:** DEPLOYED - Runtime JS errors on product pages

---

## Summary

Build successful, database created, auth working. However, **product-related pages crash with JavaScript errors** due to API response handling issues.

---

## What Works

- ✅ Main page loads
- ✅ Admin login works (admin@example.com / Admin123!@#$)
- ✅ Admin Dashboard loads
- ✅ Admin Categories page works ("Категории не найдены" - empty state OK)
- ✅ `/api/currencies/public` → 200 OK
- ✅ `/api/categories/public` → 200 OK (after v3 fix)

---

## Bug 1: Public Catalog - Featured Products 404

**Score:** 8 (Complexity: 2×3=6, Files: 2×2=4, Risk: -2)

**URL:** https://saas.mix-id.ru/catalog

**Symptom:** Page stuck on "Загрузка товаров..."

**Console error:**
```
TypeError: Cannot read properties of undefined (reading 'total')
```

**API issue:**
```
GET /api/products/public/featured → 404 Not Found
```

**Root cause:** The endpoint `/api/products/public/featured` doesn't exist or isn't registered correctly.

**Files to check:**
- `backend-hono/src/routes/products.ts` - check if `/public/featured` route exists
- `backend-hono/src/index.ts` - verify route mounting

**Fix approach:**
1. Add `/public/featured` route to products.ts that returns featured products
2. Or modify existing `/public` route to support `?featured=true` query param
3. Ensure response has `{ products: [], total: 0 }` structure even when empty

---

## Bug 2: Admin Products List - Undefined Length

**Score:** 7 (Complexity: 2×3=6, Files: 2×2=4, Risk: -3)

**URL:** https://saas.mix-id.ru/admin/products

**Symptom:** Page stuck on "Загрузка..."

**Console error:**
```
TypeError: Cannot read properties of undefined (reading 'length')
    at ProductsList.BP28qfRg.js:2:146
```

**Root cause:** The admin products API returns undefined or doesn't include expected array.

**Files to check:**
- `backend-hono/src/routes/products.ts` - admin list endpoint
- `frontend-astro/src/components/admin/ProductsList.svelte` - null check for products array

**Fix approach:**
1. Check API response structure: should be `{ products: [], total: 0, ... }`
2. Add null checks in frontend: `products?.length` or `products ?? []`
3. Ensure API returns empty array `[]` not `undefined` when no products

---

## Bug 3: Page Timeout on Admin Currencies

**Score:** 3 (Complexity: 1×3=3, Risk: 0)

**URL:** https://saas.mix-id.ru/admin/currencies

**Symptom:** Page takes >60s to load, browser times out

**Likely cause:** Infinite loop or hanging API call in currencies admin page.

**Note:** Lower priority - may be related to same API response handling issue.

---

## Common Pattern

Both Bug 1 and Bug 2 have the same root cause pattern:
- API returns undefined/null instead of empty array
- Frontend tries to access `.length` or `.total` on undefined
- Page crashes before rendering empty state

**Recommended unified fix:**

1. **Backend:** Ensure all list endpoints return:
```json
{
  "products": [],  // Always array, never undefined
  "total": 0,
  "page": 1,
  "limit": 20
}
```

2. **Frontend:** Add defensive checks:
```typescript
// Before
products.length

// After
(products ?? []).length
// or
products?.length ?? 0
```

---

## Testing Commands

```bash
# Test API endpoints
curl https://saas.mix-id.ru/api/products/public
curl https://saas.mix-id.ru/api/products/public/featured
curl -H "Authorization: Bearer TOKEN" https://saas.mix-id.ru/api/products

# Browser test
# 1. https://saas.mix-id.ru/catalog - should show empty state
# 2. https://saas.mix-id.ru/admin/products - should show "Нет товаров"
```

---

## Recommended Fix Order

1. **First: Fix `/api/products/public/featured` endpoint** (Bug 1)
   - This unblocks the public catalog page

2. **Second: Fix admin products list response** (Bug 2)
   - This enables admin product management

3. **Third: Investigate currencies timeout** (Bug 3)
   - May resolve automatically after above fixes

4. **Verify:** Run `npx tsc --noEmit` before pushing

---

## Branch to create

Create new branch: `claude/fix-products-api-v4`

Base on: `main`

---

*Generated by CLI Integrator (Browser Audit - Workflow v4.2)*
