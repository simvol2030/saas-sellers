---
/**
 * InstagramFeed Section - лента Instagram-style
 *
 * Features:
 * - Сетка постов в стиле Instagram
 * - Hover overlay с likes/comments
 * - Lightbox просмотр
 * - Адаптивная сетка (2-4 колонки)
 * - Caption при развёртывании
 */

import type { InstagramFeedSection } from '../../lib/parser';

interface Props extends Omit<InstagramFeedSection, 'type'> {}

const {
  id,
  className,
  title,
  posts,
} = Astro.props;

const feedId = id || `instagram-${Math.random().toString(36).substr(2, 9)}`;
---

<section
  id={id}
  class:list={['instagram-feed section', className]}
>
  <div class="container">
    {title && (
      <h2 class="instagram-feed-title">{title}</h2>
    )}

    <div class="instagram-grid" data-feed={feedId}>
      {posts.map((post, index) => (
        <div
          class="instagram-post"
          data-index={index}
          data-image={post.image}
          data-caption={post.caption || ''}
          data-link={post.link || ''}
        >
          <img
            src={post.image}
            alt={post.caption || 'Instagram post'}
            class="instagram-image"
            loading="lazy"
          />

          <div class="instagram-overlay">
            <div class="instagram-stats">
              {post.likes !== undefined && (
                <span class="instagram-stat">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                  </svg>
                  <span>{post.likes.toLocaleString()}</span>
                </span>
              )}
              {post.comments !== undefined && (
                <span class="instagram-stat">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                  </svg>
                  <span>{post.comments.toLocaleString()}</span>
                </span>
              )}
            </div>
          </div>
        </div>
      ))}
    </div>
  </div>

  <!-- Lightbox -->
  <div
    class="instagram-lightbox"
    id={`lightbox-${feedId}`}
    role="dialog"
    aria-modal="true"
    hidden
  >
    <div class="instagram-lightbox-backdrop"></div>
    <div class="instagram-lightbox-content">
      <button type="button" class="instagram-lightbox-close" aria-label="Закрыть">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>

      <div class="instagram-lightbox-image-wrapper">
        <img class="instagram-lightbox-image" src="" alt="" />
      </div>

      <div class="instagram-lightbox-sidebar">
        <div class="instagram-lightbox-caption"></div>
        <a class="instagram-lightbox-link" href="" target="_blank" rel="noopener noreferrer" hidden>
          Открыть в Instagram
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
            <polyline points="15 3 21 3 21 9"/>
            <line x1="10" y1="14" x2="21" y2="3"/>
          </svg>
        </a>
      </div>
    </div>
  </div>
</section>

<style>
  .instagram-feed-title {
    margin: 0 0 var(--spacing-8);
    font-size: var(--font-font-size-3xl);
    font-weight: var(--font-font-weight-bold);
    text-align: center;
    color: var(--color-text);
  }

  .instagram-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--spacing-2);
  }

  @media (min-width: 640px) {
    .instagram-grid {
      grid-template-columns: repeat(3, 1fr);
      gap: var(--spacing-3);
    }
  }

  @media (min-width: 1024px) {
    .instagram-grid {
      grid-template-columns: repeat(4, 1fr);
    }
  }

  /* Post */
  .instagram-post {
    position: relative;
    aspect-ratio: 1;
    overflow: hidden;
    cursor: pointer;
    border-radius: var(--radius-md);
  }

  .instagram-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform var(--transition-normal);
  }

  .instagram-post:hover .instagram-image {
    transform: scale(1.05);
  }

  /* Overlay */
  .instagram-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.5);
    opacity: 0;
    transition: opacity var(--transition-normal);
  }

  .instagram-post:hover .instagram-overlay {
    opacity: 1;
  }

  .instagram-stats {
    display: flex;
    gap: var(--spacing-4);
    color: white;
  }

  .instagram-stat {
    display: flex;
    align-items: center;
    gap: var(--spacing-1);
    font-size: var(--font-font-size-base);
    font-weight: var(--font-font-weight-semibold);
  }

  /* Lightbox */
  .instagram-lightbox {
    position: fixed;
    inset: 0;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .instagram-lightbox[hidden] {
    display: none;
  }

  .instagram-lightbox-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.95);
  }

  .instagram-lightbox-content {
    position: relative;
    display: flex;
    max-width: 1000px;
    max-height: 90vh;
    width: 100%;
    margin: var(--spacing-4);
    background: var(--color-background);
    border-radius: var(--radius-xl);
    overflow: hidden;
  }

  @media (max-width: 767px) {
    .instagram-lightbox-content {
      flex-direction: column;
    }
  }

  .instagram-lightbox-close {
    position: absolute;
    top: var(--spacing-4);
    right: var(--spacing-4);
    padding: var(--spacing-2);
    background: rgba(0, 0, 0, 0.5);
    border: none;
    border-radius: var(--radius-full);
    color: white;
    cursor: pointer;
    z-index: 10;
    transition: background var(--transition-fast);
  }

  .instagram-lightbox-close:hover {
    background: rgba(0, 0, 0, 0.7);
  }

  .instagram-lightbox-image-wrapper {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #000;
    min-height: 300px;
  }

  .instagram-lightbox-image {
    max-width: 100%;
    max-height: 80vh;
    object-fit: contain;
  }

  .instagram-lightbox-sidebar {
    width: 300px;
    padding: var(--spacing-6);
    display: flex;
    flex-direction: column;
    gap: var(--spacing-4);
  }

  @media (max-width: 767px) {
    .instagram-lightbox-sidebar {
      width: 100%;
    }
  }

  .instagram-lightbox-caption {
    flex: 1;
    font-size: var(--font-font-size-base);
    color: var(--color-text-secondary);
    line-height: var(--font-line-height-relaxed);
    overflow-y: auto;
  }

  .instagram-lightbox-link {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-2);
    color: var(--color-primary);
    text-decoration: none;
    font-weight: var(--font-font-weight-medium);
  }

  .instagram-lightbox-link:hover {
    text-decoration: underline;
  }

  .instagram-lightbox-link[hidden] {
    display: none;
  }
</style>

<script define:vars={{ feedId }}>
  document.addEventListener('DOMContentLoaded', () => {
    const grid = document.querySelector(`[data-feed="${feedId}"]`);
    const lightbox = document.getElementById(`lightbox-${feedId}`);

    if (!grid || !lightbox) return;

    const posts = grid.querySelectorAll('.instagram-post');
    const lightboxImage = lightbox.querySelector('.instagram-lightbox-image');
    const lightboxCaption = lightbox.querySelector('.instagram-lightbox-caption');
    const lightboxLink = lightbox.querySelector('.instagram-lightbox-link');
    const closeBtn = lightbox.querySelector('.instagram-lightbox-close');
    const backdrop = lightbox.querySelector('.instagram-lightbox-backdrop');

    function openLightbox(post) {
      const image = post.dataset.image;
      const caption = post.dataset.caption;
      const link = post.dataset.link;

      lightboxImage.src = image;
      lightboxImage.alt = caption || 'Instagram post';
      lightboxCaption.textContent = caption || '';

      if (link) {
        lightboxLink.href = link;
        lightboxLink.hidden = false;
      } else {
        lightboxLink.hidden = true;
      }

      lightbox.hidden = false;
      document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
      lightbox.hidden = true;
      document.body.style.overflow = '';
    }

    posts.forEach(post => {
      post.addEventListener('click', () => openLightbox(post));
    });

    closeBtn.addEventListener('click', closeLightbox);
    backdrop.addEventListener('click', closeLightbox);

    document.addEventListener('keydown', (e) => {
      if (!lightbox.hidden && e.key === 'Escape') {
        closeLightbox();
      }
    });
  });
</script>
