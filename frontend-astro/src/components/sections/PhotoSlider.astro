---
/**
 * PhotoSlider Section - слайдер изображений
 *
 * Features:
 * - Автопроигрывание с настраиваемым интервалом
 * - Навигация стрелками и точками
 * - Swipe на мобильных устройствах
 * - Подписи и ссылки для изображений
 * - Pause on hover
 */

import type { PhotoSliderSection } from '../../lib/parser';

interface Props extends Omit<PhotoSliderSection, 'type'> {}

const {
  id,
  className,
  title,
  images,
  autoplay = false,
  interval = 5000,
} = Astro.props;

const sliderId = id || `slider-${Math.random().toString(36).substr(2, 9)}`;
---

<section
  id={id}
  class:list={['photo-slider section', className]}
>
  <div class="container">
    {title && (
      <h2 class="photo-slider-title">{title}</h2>
    )}

    <div
      class="slider"
      data-slider={sliderId}
      data-autoplay={autoplay}
      data-interval={interval}
    >
      <div class="slider-track">
        {images.map((image, index) => (
          <div class="slider-slide" data-index={index}>
            {image.link ? (
              <a href={image.link} class="slider-link">
                <img
                  src={image.src}
                  alt={image.alt || ''}
                  class="slider-image"
                  loading={index === 0 ? 'eager' : 'lazy'}
                />
              </a>
            ) : (
              <img
                src={image.src}
                alt={image.alt || ''}
                class="slider-image"
                loading={index === 0 ? 'eager' : 'lazy'}
              />
            )}
            {image.caption && (
              <div class="slider-caption">{image.caption}</div>
            )}
          </div>
        ))}
      </div>

      <!-- Navigation arrows -->
      <button
        type="button"
        class="slider-nav slider-prev"
        aria-label="Предыдущий слайд"
      >
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="m15 18-6-6 6-6"/>
        </svg>
      </button>

      <button
        type="button"
        class="slider-nav slider-next"
        aria-label="Следующий слайд"
      >
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="m9 18 6-6-6-6"/>
        </svg>
      </button>

      <!-- Dots navigation -->
      <div class="slider-dots">
        {images.map((_, index) => (
          <button
            type="button"
            class="slider-dot"
            data-dot={index}
            aria-label={`Перейти к слайду ${index + 1}`}
          />
        ))}
      </div>

      <!-- Progress bar for autoplay -->
      {autoplay && (
        <div class="slider-progress">
          <div class="slider-progress-bar"></div>
        </div>
      )}
    </div>
  </div>
</section>

<style>
  .photo-slider-title {
    margin: 0 0 var(--spacing-8);
    font-size: var(--font-font-size-3xl);
    font-weight: var(--font-font-weight-bold);
    text-align: center;
    color: var(--color-text);
  }

  .slider {
    position: relative;
    overflow: hidden;
    border-radius: var(--radius-2xl);
    background: var(--color-background-secondary);
  }

  .slider-track {
    display: flex;
    transition: transform 0.5s ease-in-out;
  }

  .slider-slide {
    flex: 0 0 100%;
    position: relative;
  }

  .slider-link {
    display: block;
  }

  .slider-image {
    width: 100%;
    aspect-ratio: 16 / 9;
    object-fit: cover;
    display: block;
  }

  .slider-caption {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: var(--spacing-4) var(--spacing-6);
    background: linear-gradient(
      to top,
      rgba(0, 0, 0, 0.7) 0%,
      transparent 100%
    );
    color: white;
    font-size: var(--font-font-size-base);
  }

  /* Navigation arrows */
  .slider-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    padding: var(--spacing-3);
    background: rgba(255, 255, 255, 0.9);
    border: none;
    border-radius: var(--radius-full);
    color: var(--color-text);
    cursor: pointer;
    transition: all var(--transition-fast);
    z-index: 10;
    box-shadow: var(--shadow-md);
    opacity: 0;
  }

  .slider:hover .slider-nav {
    opacity: 1;
  }

  .slider-nav:hover {
    background: white;
    box-shadow: var(--shadow-lg);
  }

  .slider-nav:focus-visible {
    opacity: 1;
    outline: 2px solid var(--color-primary);
    outline-offset: 2px;
  }

  .slider-prev {
    left: var(--spacing-4);
  }

  .slider-next {
    right: var(--spacing-4);
  }

  /* Dots navigation */
  .slider-dots {
    position: absolute;
    bottom: var(--spacing-4);
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: var(--spacing-2);
    z-index: 10;
  }

  .slider-dot {
    width: 10px;
    height: 10px;
    padding: 0;
    border: none;
    border-radius: var(--radius-full);
    background: rgba(255, 255, 255, 0.5);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .slider-dot:hover {
    background: rgba(255, 255, 255, 0.8);
  }

  .slider-dot.active {
    background: white;
    width: 24px;
  }

  .slider-dot:focus-visible {
    outline: 2px solid var(--color-primary);
    outline-offset: 2px;
  }

  /* Progress bar */
  .slider-progress {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: rgba(255, 255, 255, 0.3);
    z-index: 10;
  }

  .slider-progress-bar {
    height: 100%;
    background: var(--color-primary);
    width: 0;
    transition: width linear;
  }

  .slider.paused .slider-progress-bar {
    animation-play-state: paused;
  }

  /* Mobile touch-friendly */
  @media (max-width: 767px) {
    .slider-nav {
      padding: var(--spacing-2);
      opacity: 1;
    }

    .slider-prev {
      left: var(--spacing-2);
    }

    .slider-next {
      right: var(--spacing-2);
    }
  }
</style>

<script define:vars={{ sliderId }}>
  document.addEventListener('DOMContentLoaded', () => {
    const slider = document.querySelector(`[data-slider="${sliderId}"]`);
    if (!slider) return;

    const track = slider.querySelector('.slider-track');
    const slides = slider.querySelectorAll('.slider-slide');
    const dots = slider.querySelectorAll('.slider-dot');
    const prevBtn = slider.querySelector('.slider-prev');
    const nextBtn = slider.querySelector('.slider-next');
    const progressBar = slider.querySelector('.slider-progress-bar');

    const autoplay = slider.dataset.autoplay === 'true';
    const interval = parseInt(slider.dataset.interval) || 5000;

    let currentIndex = 0;
    let autoplayTimer = null;
    let isPaused = false;
    let touchStartX = 0;
    let touchEndX = 0;

    function goToSlide(index) {
      currentIndex = index;
      track.style.transform = `translateX(-${currentIndex * 100}%)`;
      updateDots();
      resetProgress();
    }

    function updateDots() {
      dots.forEach((dot, i) => {
        dot.classList.toggle('active', i === currentIndex);
      });
    }

    function showPrev() {
      currentIndex = (currentIndex - 1 + slides.length) % slides.length;
      goToSlide(currentIndex);
    }

    function showNext() {
      currentIndex = (currentIndex + 1) % slides.length;
      goToSlide(currentIndex);
    }

    function startAutoplay() {
      if (!autoplay || isPaused) return;

      if (progressBar) {
        progressBar.style.transition = `width ${interval}ms linear`;
        progressBar.style.width = '100%';
      }

      autoplayTimer = setTimeout(() => {
        showNext();
        startAutoplay();
      }, interval);
    }

    function stopAutoplay() {
      if (autoplayTimer) {
        clearTimeout(autoplayTimer);
        autoplayTimer = null;
      }

      if (progressBar) {
        progressBar.style.transition = 'none';
        progressBar.style.width = '0';
      }
    }

    function resetProgress() {
      stopAutoplay();
      startAutoplay();
    }

    // Event listeners
    prevBtn.addEventListener('click', () => {
      showPrev();
    });

    nextBtn.addEventListener('click', () => {
      showNext();
    });

    dots.forEach((dot, index) => {
      dot.addEventListener('click', () => {
        goToSlide(index);
      });
    });

    // Pause on hover
    slider.addEventListener('mouseenter', () => {
      isPaused = true;
      slider.classList.add('paused');
      stopAutoplay();
    });

    slider.addEventListener('mouseleave', () => {
      isPaused = false;
      slider.classList.remove('paused');
      startAutoplay();
    });

    // Touch swipe
    slider.addEventListener('touchstart', (e) => {
      touchStartX = e.changedTouches[0].screenX;
      isPaused = true;
      stopAutoplay();
    });

    slider.addEventListener('touchend', (e) => {
      touchEndX = e.changedTouches[0].screenX;
      handleSwipe();
      isPaused = false;
      startAutoplay();
    });

    function handleSwipe() {
      const swipeThreshold = 50;
      const diff = touchStartX - touchEndX;

      if (Math.abs(diff) > swipeThreshold) {
        if (diff > 0) {
          showNext();
        } else {
          showPrev();
        }
      }
    }

    // Keyboard navigation
    slider.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') {
        showPrev();
      } else if (e.key === 'ArrowRight') {
        showNext();
      }
    });

    // Initialize
    updateDots();
    startAutoplay();
  });
</script>
